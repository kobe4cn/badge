name: E2E Tests

on:
  push:
    branches: [main, feature/*]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend
          - performance

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

# 权限设置：test-reporter 需要写入 checks
permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # sqlx-cli 使用 DATABASE_URL 进行迁移
  DATABASE_URL: postgres://badge:badge@localhost:5432/badge_test
  # 服务配置使用 BADGE_ 前缀的环境变量
  BADGE_DATABASE_URL: postgres://badge:badge@localhost:5432/badge_test
  BADGE_REDIS_URL: redis://localhost:6379
  BADGE_KAFKA_BROKERS: localhost:9092
  # 旧名称保留用于兼容
  REDIS_URL: redis://localhost:6379
  KAFKA_BROKERS: localhost:9092

jobs:
  # 后端 E2E 测试
  backend-e2e:
    name: Backend E2E Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'backend' || github.event.inputs.test_suite == '' }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: badge
          POSTGRES_PASSWORD: badge
          POSTGRES_DB: badge_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      kafka:
        image: confluentinc/cp-kafka:7.5.0
        ports:
          - 9092:9092
        env:
          KAFKA_NODE_ID: 1
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_PROCESS_ROLES: broker,controller
          KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:29093
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://localhost:29093
          KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
          CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev cmake pkg-config protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features native-tls,postgres

      - name: Run database migrations
        run: sqlx database create && sqlx migrate run

      - name: Build all services
        run: |
          # 先完整编译所有服务，避免并发 cargo run 时的锁争用
          cargo build -p badge-admin-service --bin badge-admin
          cargo build -p badge-management-service --bin badge-management
          cargo build -p unified-rule-engine --bin rule-engine
          cargo build -p event-engagement-service --bin event-engagement
          cargo build -p event-transaction-service --bin event-transaction
          cargo build -p notification-worker --bin notification-worker

      - name: Start services
        run: |
          # 启动后台服务，使用已编译的二进制文件
          ./target/debug/badge-admin > /tmp/badge-admin.log 2>&1 &
          ./target/debug/badge-management > /tmp/badge-management.log 2>&1 &
          ./target/debug/rule-engine > /tmp/rule-engine.log 2>&1 &
          ./target/debug/event-engagement > /tmp/event-engagement.log 2>&1 &
          ./target/debug/event-transaction > /tmp/event-transaction.log 2>&1 &
          ./target/debug/notification-worker > /tmp/notification-worker.log 2>&1 &

      - name: Wait for services to be ready
        run: |
          # HTTP 服务健康检查
          wait_for_http_service() {
            local name=$1
            local url=$2
            local log_file=$3
            echo "等待 ${name} 就绪 (HTTP: ${url})..."
            for i in $(seq 1 60); do
              if curl -sf "${url}" > /dev/null 2>&1; then
                echo "${name} 已就绪 (耗时 $((i*2))s)"
                return 0
              fi
              if [ $i -eq 60 ]; then
                echo "::error::${name} 在 120s 内未能启动"
                echo "=== ${name} 日志 ==="
                cat "${log_file}" 2>/dev/null || echo "（日志文件不存在）"
                return 1
              fi
              sleep 2
            done
          }

          # gRPC 服务端口检查（gRPC 使用 HTTP/2，curl 无法直接检查，改用 nc 检测端口）
          wait_for_grpc_service() {
            local name=$1
            local port=$2
            local log_file=$3
            echo "等待 ${name} 就绪 (gRPC: port ${port})..."
            for i in $(seq 1 60); do
              if nc -z localhost "${port}" 2>/dev/null; then
                echo "${name} 已就绪 (耗时 $((i*2))s)"
                return 0
              fi
              if [ $i -eq 60 ]; then
                echo "::error::${name} 在 120s 内未能启动"
                echo "=== ${name} 日志 ==="
                cat "${log_file}" 2>/dev/null || echo "（日志文件不存在）"
                return 1
              fi
              sleep 2
            done
          }

          # 并行等待所有服务
          # HTTP 服务
          wait_for_http_service "badge-admin-service" "http://localhost:8080/health" "/tmp/badge-admin.log" &
          pid1=$!
          # gRPC 服务（使用端口检测）
          wait_for_grpc_service "badge-management-service" "50052" "/tmp/badge-management.log" &
          pid2=$!
          wait_for_grpc_service "rule-engine-service" "50051" "/tmp/rule-engine.log" &
          pid3=$!
          # Kafka 消费者服务使用 metrics 端口检测（event-engagement 没有 HTTP /health，使用 metrics 端口 9993）
          wait_for_grpc_service "event-engagement-service" "9993" "/tmp/event-engagement.log" &
          pid4=$!

          # 等待所有健康检查完成，任一失败则退出
          failed=0
          for pid in $pid1 $pid2 $pid3 $pid4; do
            wait $pid || failed=1
          done

          if [ $failed -eq 1 ]; then
            echo "::error::部分服务未能正常启动"
            exit 1
          fi

          echo "所有服务已就绪"

      - name: Install cargo2junit
        run: cargo install cargo2junit

      - name: Run E2E tests
        run: |
          # 确保输出目录存在
          mkdir -p target/test-results

          # 运行测试并转换为 JUnit 格式，保留退出码以正确反映测试结果
          # 使用 CARGO_TERM_COLOR=never 保证输出干净，不依赖 nightly -Z 参数
          set +e
          cargo test --test e2e -- --ignored --test-threads=1 2>&1 | cargo2junit > target/test-results/backend-e2e.xml
          TEST_EXIT_CODE=$?
          set -e

          # 如果没有生成有效的 XML 文件，创建一个空的测试报告
          if [ ! -s target/test-results/backend-e2e.xml ]; then
            echo '<?xml version="1.0" encoding="UTF-8"?><testsuites><testsuite name="backend-e2e" tests="0" failures="0" errors="0" skipped="0"></testsuite></testsuites>' > target/test-results/backend-e2e.xml
          fi

          exit $TEST_EXIT_CODE
        env:
          ADMIN_SERVICE_URL: http://localhost:8080
          RULE_ENGINE_ADDR: http://localhost:50051
          BADGE_MANAGEMENT_ADDR: http://localhost:50052

      - name: Run crate-level integration tests
        run: |
          # 运行需要 PostgreSQL + Redis 的 crate 集成测试（这些在普通 cargo test 中被 ignore）
          set +e
          cargo test -p badge-management-service --test grant_service_test -- --ignored --test-threads=1 2>&1 | tee -a /tmp/crate-integration.log
          GRANT_EXIT=$?
          cargo test -p badge-management-service --test revoke_service_test -- --ignored --test-threads=1 2>&1 | tee -a /tmp/crate-integration.log
          REVOKE_EXIT=$?
          cargo test -p badge-management-service --test redemption_service_test -- --ignored --test-threads=1 2>&1 | tee -a /tmp/crate-integration.log
          REDEEM_EXIT=$?
          cargo test -p badge-management-service --test badge_flow_test -- --ignored --test-threads=1 2>&1 | tee -a /tmp/crate-integration.log
          FLOW_EXIT=$?
          set -e

          # 汇总结果
          FAILED=0
          [ $GRANT_EXIT -ne 0 ] && echo "::warning::grant_service_test 失败 (exit=$GRANT_EXIT)" && FAILED=1
          [ $REVOKE_EXIT -ne 0 ] && echo "::warning::revoke_service_test 失败 (exit=$REVOKE_EXIT)" && FAILED=1
          [ $REDEEM_EXIT -ne 0 ] && echo "::warning::redemption_service_test 失败 (exit=$REDEEM_EXIT)" && FAILED=1
          [ $FLOW_EXIT -ne 0 ] && echo "::warning::badge_flow_test 失败 (exit=$FLOW_EXIT)" && FAILED=1

          if [ $FAILED -ne 0 ]; then
            echo "::error::部分 crate 集成测试失败，详见上方日志"
            exit 1
          fi
        env:
          DATABASE_URL: postgres://badge:badge@localhost:5432/badge_test
          BADGE_DATABASE_URL: postgres://badge:badge@localhost:5432/badge_test
          BADGE_REDIS_URL: redis://localhost:6379

      - name: Backend test report
        uses: dorny/test-reporter@v1
        if: always()
        continue-on-error: true
        with:
          name: Backend E2E Results
          path: target/test-results/backend-e2e.xml
          reporter: java-junit
          fail-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-e2e-results
          path: target/test-results/

  # 前端 E2E 测试
  frontend-e2e:
    name: Frontend E2E Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'frontend' || github.event.inputs.test_suite == '' }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: badge
          POSTGRES_PASSWORD: badge
          POSTGRES_DB: badge_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev cmake pkg-config protobuf-compiler

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/admin-ui/package-lock.json

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-frontend-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-frontend-
            ${{ runner.os }}-cargo-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('web/admin-ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features native-tls,postgres

      - name: Run database migrations
        run: sqlx database create && sqlx migrate run

      - name: Build backend
        run: cargo build -p badge-admin-service --bin badge-admin

      - name: Start backend
        run: |
          ./target/debug/badge-admin > /tmp/badge-admin.log 2>&1 &

      - name: Wait for backend to be ready
        run: |
          echo "等待 badge-admin-service 就绪..."
          for i in $(seq 1 60); do
            if curl -sf http://localhost:8080/health > /dev/null 2>&1; then
              echo "badge-admin-service 已就绪 (耗时 $((i*2))s)"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "::error::badge-admin-service 在 120s 内未能启动"
              echo "=== badge-admin-service 日志 ==="
              cat /tmp/badge-admin.log 2>/dev/null || echo "（日志文件不存在）"
              exit 1
            fi
            sleep 2
          done

      - name: Install frontend dependencies
        run: cd web/admin-ui && npm ci

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd web/admin-ui && npx playwright install --with-deps

      - name: Install Playwright system deps only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: cd web/admin-ui && npx playwright install-deps

      - name: Start frontend dev server
        run: |
          # 使用 dev:real 禁用 Mock 模式，确保所有 API 请求（包括认证）都转发到真实后端
          cd web/admin-ui && npm run dev:real > /tmp/frontend-dev.log 2>&1 &

      - name: Wait for frontend dev server to be ready
        run: |
          echo "等待前端开发服务器就绪..."
          # Vite 配置端口为 3001（见 vite.config.ts server.port）
          for i in $(seq 1 60); do
            if curl -sf http://localhost:3001 > /dev/null 2>&1; then
              echo "前端开发服务器已就绪 (耗时 $((i*2))s)"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "::error::前端开发服务器在 120s 内未能启动"
              echo "=== 前端开发服务器日志 ==="
              cat /tmp/frontend-dev.log 2>/dev/null || echo "（日志文件不存在）"
              exit 1
            fi
            sleep 2
          done

      - name: Run Playwright tests
        run: |
          cd web/admin-ui
          # 临时重命名 vitest 单元测试目录，避免 Playwright 模块解析时触发 @vitest/expect 冲突
          # 这些文件导入了 vitest，会触发 @vitest/expect 初始化与 Playwright expect 冲突
          find src -type d -name "__tests__" -exec mv {} {}__disabled \; 2>/dev/null || true
          mv test-setup.ts test-setup.ts.bak 2>/dev/null || true
          mv vitest.config.ts vitest.config.ts.bak 2>/dev/null || true

          npx playwright test --config=e2e/playwright.config.ts --project=chromium

          # 恢复
          find src -type d -name "__tests____disabled" -exec sh -c 'mv "$1" "${1%__disabled}"' _ {} \; 2>/dev/null || true
          mv test-setup.ts.bak test-setup.ts 2>/dev/null || true
          mv vitest.config.ts.bak vitest.config.ts 2>/dev/null || true
        env:
          # BASE_URL: Playwright 使用 Vite 开发服务器地址，Vite 代理 /api 请求到后端
          BASE_URL: http://localhost:3001
          # BACKEND_URL: 用于集成测试直接访问后端 API（绕过 Vite）
          BACKEND_URL: http://localhost:8080
      - name: Frontend test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Frontend E2E Results
          # playwright.config.ts 的 junit outputFile 相对于 config 文件目录 (e2e/)
          path: web/admin-ui/e2e/test-results/junit.xml
          reporter: java-junit
          fail-on-error: true

      - name: Upload Playwright HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: web/admin-ui/e2e/playwright-report/
          retention-days: 14

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots
          path: web/admin-ui/e2e/test-results/

  # 性能测试（仅在手动触发时运行）
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'performance' }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: badge
          POSTGRES_PASSWORD: badge
          POSTGRES_DB: badge_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379

      kafka:
        image: confluentinc/cp-kafka:7.5.0
        ports:
          - 9092:9092
        env:
          KAFKA_NODE_ID: 1
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_PROCESS_ROLES: broker,controller
          KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:29093
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://localhost:29093
          KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
          CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev cmake pkg-config protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-perf-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-perf-
            ${{ runner.os }}-cargo-

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features native-tls,postgres

      - name: Run database migrations
        run: sqlx database create && sqlx migrate run

      - name: Build services
        run: |
          cargo build --release -p badge-admin-service --bin badge-admin
          cargo build --release -p badge-management-service --bin badge-management
          cargo build --release -p unified-rule-engine --bin rule-engine
          cargo build --release -p event-engagement-service --bin event-engagement

      - name: Start services
        run: |
          ./target/release/badge-admin > /tmp/badge-admin.log 2>&1 &
          ./target/release/badge-management > /tmp/badge-management.log 2>&1 &
          ./target/release/rule-engine > /tmp/rule-engine.log 2>&1 &
          ./target/release/event-engagement > /tmp/event-engagement.log 2>&1 &

      - name: Wait for services to be ready
        run: |
          # HTTP 服务健康检查
          wait_for_http_service() {
            local name=$1
            local url=$2
            local log_file=$3
            echo "等待 ${name} 就绪 (HTTP: ${url})..."
            for i in $(seq 1 60); do
              if curl -sf "${url}" > /dev/null 2>&1; then
                echo "${name} 已就绪 (耗时 $((i*2))s)"
                return 0
              fi
              if [ $i -eq 60 ]; then
                echo "::error::${name} 在 120s 内未能启动"
                echo "=== ${name} 日志 ==="
                cat "${log_file}" 2>/dev/null || echo "（日志文件不存在）"
                return 1
              fi
              sleep 2
            done
          }

          # gRPC 服务端口检查
          wait_for_grpc_service() {
            local name=$1
            local port=$2
            local log_file=$3
            echo "等待 ${name} 就绪 (gRPC: port ${port})..."
            for i in $(seq 1 60); do
              if nc -z localhost "${port}" 2>/dev/null; then
                echo "${name} 已就绪 (耗时 $((i*2))s)"
                return 0
              fi
              if [ $i -eq 60 ]; then
                echo "::error::${name} 在 120s 内未能启动"
                echo "=== ${name} 日志 ==="
                cat "${log_file}" 2>/dev/null || echo "（日志文件不存在）"
                return 1
              fi
              sleep 2
            done
          }

          # HTTP 服务
          wait_for_http_service "badge-admin-service" "http://localhost:8080/health" "/tmp/badge-admin.log" &
          pid1=$!
          # gRPC 服务
          wait_for_grpc_service "badge-management-service" "50052" "/tmp/badge-management.log" &
          pid2=$!
          wait_for_grpc_service "rule-engine-service" "50051" "/tmp/rule-engine.log" &
          pid3=$!
          # Kafka 消费者服务使用 metrics 端口检测
          wait_for_grpc_service "event-engagement-service" "9993" "/tmp/event-engagement.log" &
          pid4=$!

          failed=0
          for pid in $pid1 $pid2 $pid3 $pid4; do
            wait $pid || failed=1
          done

          if [ $failed -eq 1 ]; then
            echo "::error::部分服务未能正常启动"
            exit 1
          fi

          echo "所有服务已就绪"

      - name: Run performance tests
        run: cargo test --test performance -- --ignored --test-threads=1
        env:
          ADMIN_SERVICE_URL: http://localhost:8080
          EVENT_ENGAGEMENT_URL: http://localhost:8081

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: target/performance-results/

  # 聚合所有测试结果
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [backend-e2e, frontend-e2e]

    steps:
      - name: Download backend results
        uses: actions/download-artifact@v4
        with:
          name: backend-e2e-results
          path: test-results/backend/
        continue-on-error: true

      - name: Download frontend results
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: test-results/frontend/
        continue-on-error: true

      - name: Upload aggregated results
        uses: actions/upload-artifact@v4
        with:
          name: all-test-results
          path: test-results/
          retention-days: 30

      - name: Check test outcomes
        run: |
          echo "Backend E2E: ${{ needs.backend-e2e.result }}"
          echo "Frontend E2E: ${{ needs.frontend-e2e.result }}"
          if [ "${{ needs.backend-e2e.result }}" = "failure" ] || [ "${{ needs.frontend-e2e.result }}" = "failure" ]; then
            echo "::error::One or more E2E test suites failed"
            exit 1
          fi
