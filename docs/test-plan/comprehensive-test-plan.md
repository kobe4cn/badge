# Badge 系统全面测试方案

## 一、测试范围概述

### 1.1 测试目标
- 验证前后端功能完整性和数据一致性
- 验证全链路业务流程（创建 → 配置 → 触发 → 发放 → 兑换 → 通知）
- 验证高并发场景下的系统稳定性和性能
- 验证异常场景和逆向流程的正确处理

### 1.2 测试环境
| 组件 | 说明 |
|------|------|
| 数据库 | PostgreSQL (Podman) |
| 缓存 | Redis (Podman) |
| 消息队列 | Kafka (Podman) |
| Mock 服务 | mock-services (端口 8090) |
| 后端服务 | badge-admin (8080), badge-management (50052), rule-engine (50051) |
| 前端 | admin-ui (Vite dev server) |

---

## 二、功能测试用例

### 2.1 基础配置模块

#### TC-2.1.1 徽章分类管理
| 用例ID | 场景 | 步骤 | 预期结果 | 验证点 |
|--------|------|------|----------|--------|
| CAT-001 | 创建徽章分类 | 1. 前端填写分类名称、描述、图标<br>2. 提交创建 | 创建成功，返回分类ID | DB: badge_categories 新增记录 |
| CAT-002 | 创建子分类 | 1. 选择父分类<br>2. 创建子分类 | 层级关系正确 | DB: parent_id 正确关联 |
| CAT-003 | 编辑分类 | 修改分类名称和描述 | 更新成功 | DB: updated_at 更新 |
| CAT-004 | 删除空分类 | 删除无徽章的分类 | 删除成功 | DB: 记录删除 |
| CAT-005 | 删除非空分类 | 删除有徽章的分类 | 拒绝删除，提示错误 | API: 返回 400 错误 |

#### TC-2.1.2 徽章系列管理
| 用例ID | 场景 | 步骤 | 预期结果 | 验证点 |
|--------|------|------|----------|--------|
| SER-001 | 创建徽章系列 | 填写系列名称、主题、描述 | 创建成功 | DB: badge_series 新增 |
| SER-002 | 系列关联分类 | 创建时选择所属分类 | 关联正确 | DB: category_id 正确 |
| SER-003 | 系列进度配置 | 配置解锁进度显示 | 配置保存 | DB: progress_config JSON |

#### TC-2.1.3 徽章定义创建
| 用例ID | 场景 | 步骤 | 预期结果 | 验证点 |
|--------|------|------|----------|--------|
| BDG-001 | 创建基础徽章 | 1. 选择分类/系列<br>2. 填写名称、描述、图标<br>3. 设置等级和稀有度 | 创建成功 | DB: badges 表新增 |
| BDG-002 | 创建限量徽章 | 设置 max_supply = 100 | 限量配置生效 | DB: max_supply 正确 |
| BDG-003 | 创建限时徽章 | 设置有效期起止时间 | 时间范围正确 | DB: valid_from/valid_to |
| BDG-004 | 徽章图片上传 | 上传徽章图标 | 图片存储成功 | 文件存储 + DB icon_url |
| BDG-005 | 徽章状态切换 | 草稿 → 上线 → 下线 | 状态流转正确 | DB: status 字段变化 |

### 2.2 规则配置模块

#### TC-2.2.1 简单规则创建
| 用例ID | 场景 | 规则条件 | 预期结果 |
|--------|------|----------|----------|
| RUL-001 | 单条件规则 | 累计消费 >= 1000 | 规则保存，JSON 结构正确 |
| RUL-002 | 多条件 AND | 消费 >= 500 AND 订单数 >= 3 | AND 逻辑组正确 |
| RUL-003 | 多条件 OR | VIP用户 OR 消费 >= 2000 | OR 逻辑组正确 |
| RUL-004 | 嵌套规则 | (A AND B) OR (C AND D) | 嵌套结构正确 |

#### TC-2.2.2 画布规则编辑器 (React Flow)
| 用例ID | 场景 | 操作 | 预期结果 |
|--------|------|------|----------|
| CNV-001 | 拖拽条件节点 | 从工具栏拖入条件节点 | 节点创建成功 |
| CNV-002 | 连接节点 | 连接两个节点 | 边关系创建 |
| CNV-003 | 删除节点 | 删除条件节点 | 节点和关联边删除 |
| CNV-004 | 保存规则 | 点击保存 | 规则 JSON 正确存储 |
| CNV-005 | 加载规则 | 打开已有规则 | 画布正确渲染 |

#### TC-2.2.3 规则模板使用
| 用例ID | 场景 | 预期结果 |
|--------|------|----------|
| TPL-001 | 选择模板 | 模板参数表单显示 |
| TPL-002 | 填写模板参数 | 参数校验通过 |
| TPL-003 | 模板生成规则 | 规则 JSON 正确生成 |
| TPL-004 | 模板预览 | 预览规则逻辑描述 |

### 2.3 权益配置模块

#### TC-2.3.1 权益类型配置
| 用例ID | 权益类型 | 配置项 | 验证点 |
|--------|----------|--------|--------|
| BEN-001 | 积分权益 | points_amount = 100 | DB: benefit_config JSON |
| BEN-002 | 优惠券权益 | coupon_template_id | 关联外部优惠券系统 |
| BEN-003 | 实物权益 | sku_id, shipping_required | 物流信息配置 |
| BEN-004 | 多重权益 | 同时配置积分+优惠券 | 多权益组合 |

#### TC-2.3.2 权益发放记录
| 用例ID | 场景 | 验证点 |
|--------|------|--------|
| GRT-001 | 权益发放成功 | benefit_grants 表记录，status=GRANTED |
| GRT-002 | 权益发放失败 | status=FAILED, error_message |
| GRT-003 | 外部渠道查询 | 按 user_id 查询用户所有权益 |

### 2.4 徽章获取流程

#### TC-2.4.1 事件触发获取
| 用例ID | 事件类型 | 场景 | 预期结果 |
|--------|----------|------|----------|
| EVT-001 | PURCHASE | 首次购买触发新手徽章 | 徽章发放成功 |
| EVT-002 | PURCHASE | 累计消费达标触发 | 规则评估通过 |
| EVT-003 | CHECKIN | 连续签到 7 天 | 签到徽章获得 |
| EVT-004 | SHARE | 分享次数达标 | 社交徽章获得 |
| EVT-005 | REFUND | 退款后扣减消费额 | 已获徽章保留/撤销（按配置） |

#### TC-2.4.2 级联触发场景
| 用例ID | 场景 | 触发链 | 预期结果 |
|--------|------|--------|----------|
| CAS-001 | 简单级联 | A → B | A 获得后自动触发 B 检查 |
| CAS-002 | 多级级联 | A → B → C | 三级连锁触发 |
| CAS-003 | 扇出级联 | A → [B, C, D] | 一个触发多个 |
| CAS-004 | 聚合级联 | [A, B] → C | 多个满足后触发一个 |
| CAS-005 | 循环检测 | A → B → A | 检测并阻止循环 |

#### TC-2.4.3 互斥与前置条件
| 用例ID | 场景 | 预期结果 |
|--------|------|----------|
| DEP-001 | 前置徽章未获得 | 拒绝发放，返回原因 |
| DEP-002 | 前置徽章已获得 | 允许发放 |
| DEP-003 | 互斥徽章已持有 | 拒绝发放 |
| DEP-004 | 互斥组冲突 | 选择优先级高的 |

### 2.5 徽章兑换流程

#### TC-2.5.1 正常兑换
| 用例ID | 场景 | 预期结果 |
|--------|------|----------|
| RDM-001 | 兑换积分权益 | 积分到账，兑换记录创建 |
| RDM-002 | 兑换优惠券 | 优惠券发放，关联记录 |
| RDM-003 | 兑换实物 | 创建发货单 |
| RDM-004 | 部分兑换 | 仅兑换部分权益 |

#### TC-2.5.2 竞争兑换
| 用例ID | 场景 | 预期结果 |
|--------|------|----------|
| CMP-001 | 限量抢兑 | 库存扣减正确 |
| CMP-002 | 库存不足 | 返回库存不足错误 |
| CMP-003 | 并发抢兑 | 分布式锁生效，无超卖 |

### 2.6 通知系统

#### TC-2.6.1 通知触发
| 用例ID | 场景 | 通知类型 | 预期结果 |
|--------|------|----------|----------|
| NTF-001 | 获得新徽章 | BADGE_EARNED | 通知消息发送 |
| NTF-002 | 徽章点亮 | BADGE_UNLOCKED | 推送通知 |
| NTF-003 | 兑换成功 | REDEMPTION_SUCCESS | 兑换确认通知 |
| NTF-004 | 权益到账 | BENEFIT_GRANTED | 权益通知 |
| NTF-005 | 徽章即将过期 | BADGE_EXPIRING | 过期提醒 |

---

## 三、逆向场景测试

### 3.1 数据回滚场景
| 用例ID | 场景 | 操作 | 预期结果 |
|--------|------|------|----------|
| REV-001 | 退款撤销徽章 | 用户退款，消费额下降 | 根据配置撤销或保留徽章 |
| REV-002 | 订单取消 | 取消未完成订单 | 相关事件不计入 |
| REV-003 | 徽章撤销 | 管理员撤销徽章 | user_badges 标记撤销 |
| REV-004 | 权益撤销 | 撤销已发放权益 | benefit_grants 状态更新 |

### 3.2 异常场景
| 用例ID | 场景 | 预期结果 |
|--------|------|----------|
| ERR-001 | 规则引擎超时 | 返回降级结果，记录日志 |
| ERR-002 | 数据库连接失败 | 重试机制，告警 |
| ERR-003 | Kafka 消息积压 | 消费限流，监控告警 |
| ERR-004 | 外部服务不可用 | 熔断降级 |
| ERR-005 | 重复事件处理 | 幂等性保证 |

### 3.3 边界条件
| 用例ID | 场景 | 预期结果 |
|--------|------|----------|
| BND-001 | 徽章刚好到期 | 到期瞬间的处理 |
| BND-002 | 限量徽章最后一个 | 并发最后一个抢兑 |
| BND-003 | 规则条件边界值 | >= 1000 时 999 vs 1000 |
| BND-004 | 空用户数据 | 首次用户无历史数据 |

---

## 四、数据一致性验证

### 4.1 前后端数据一致性
| 检查点 | 前端操作 | 后端验证 | 数据库验证 |
|--------|----------|----------|------------|
| 徽章创建 | 表单提交 | API 响应正确 | badges 表数据一致 |
| 规则保存 | 画布保存 | 规则 JSON 完整 | badge_rules 表数据正确 |
| 权益配置 | 配置提交 | 配置解析正确 | benefit_config JSON 正确 |

### 4.2 事务一致性
| 检查点 | 场景 | 验证方法 |
|--------|------|----------|
| 徽章发放 | 发放+记录账本 | 两表数据一致 |
| 兑换事务 | 扣减+发放权益 | 事务回滚测试 |
| 级联触发 | 多徽章连锁 | 全部成功或全部回滚 |

---

## 五、报表与统计测试

### 5.1 Dashboard 报表
| 用例ID | 报表 | 验证点 |
|--------|------|--------|
| RPT-001 | 徽章发放统计 | 按时间、分类统计准确 |
| RPT-002 | 兑换转化率 | 兑换数/发放数 |
| RPT-003 | 活跃用户数 | 去重用户统计 |
| RPT-004 | 权益消耗 | 各类权益发放统计 |
| RPT-005 | 趋势图表 | 时间序列数据正确 |

### 5.2 用户维度查询
| 用例ID | 场景 | 预期结果 |
|--------|------|----------|
| USR-001 | 查询用户所有徽章 | 返回完整徽章列表 |
| USR-002 | 查询用户权益记录 | 返回权益发放历史 |
| USR-003 | 查询用户兑换记录 | 返回兑换历史 |
| USR-004 | 外部渠道 API 查询 | REST API 返回正确 |

---

## 六、性能测试方案

### 6.1 测试场景

#### 场景 1: 单用户徽章获取
```
目标: 验证单用户触发事件到徽章发放的延迟
指标: P99 延迟 < 100ms
```

#### 场景 2: 高并发徽章获取
```
并发用户: 100, 500, 1000
每用户请求: 10 次/秒
持续时间: 5 分钟
目标:
  - 吞吐量 > 5000 TPS
  - 错误率 < 0.1%
  - P99 延迟 < 500ms
```

#### 场景 3: 级联触发性能
```
场景: 单徽章触发 5 级级联
并发触发用户: 100
目标:
  - 级联完成时间 < 1s
  - 无遗漏触发
```

#### 场景 4: 竞争兑换压测
```
限量徽章库存: 100
并发抢兑用户: 1000
目标:
  - 精确发放 100 个
  - 无超卖
  - 响应时间 < 200ms
```

#### 场景 5: 混合负载
```
读写比例: 7:3
操作分布:
  - 40% 事件触发
  - 30% 查询徽章
  - 20% 兑换操作
  - 10% 管理操作
```

### 6.2 性能测试工具
- **基准测试**: Criterion (已有)
- **负载测试**: 扩展 `benches/load_test.rs`
- **压力测试**: 可选 k6 / wrk / locust

### 6.3 监控指标
| 指标 | 采集方式 | 告警阈值 |
|------|----------|----------|
| QPS | Prometheus | - |
| 延迟 P50/P99 | Prometheus | P99 > 500ms |
| 错误率 | Prometheus | > 1% |
| 数据库连接数 | Prometheus | > 80% |
| Kafka 消费延迟 | Kafka metrics | > 1000 |

---

## 七、测试执行计划

### 7.1 测试阶段

| 阶段 | 内容 | 依赖 |
|------|------|------|
| **Phase 1** | 环境准备 + Mock 服务启动 | 基础设施 |
| **Phase 2** | 基础配置模块测试 (2.1) | Phase 1 |
| **Phase 3** | 规则配置模块测试 (2.2) | Phase 2 |
| **Phase 4** | 权益配置测试 (2.3) | Phase 2 |
| **Phase 5** | 徽章获取全链路测试 (2.4) | Phase 3, 4 |
| **Phase 6** | 兑换流程测试 (2.5) | Phase 5 |
| **Phase 7** | 通知系统测试 (2.6) | Phase 5, 6 |
| **Phase 8** | 逆向场景测试 (3.x) | Phase 5, 6 |
| **Phase 9** | 数据一致性验证 (4.x) | All above |
| **Phase 10** | 报表测试 (5.x) | Phase 5, 6 |
| **Phase 11** | 性能测试 (6.x) | All above |

### 7.2 测试文件规划

```
tests/
├── e2e/
│   ├── setup.rs                    # 测试环境初始化
│   ├── mod.rs
│   ├── phase1_environment.rs       # 环境验证
│   ├── phase2_basic_config.rs      # 基础配置
│   ├── phase3_rule_config.rs       # 规则配置
│   ├── phase4_benefit_config.rs    # 权益配置
│   ├── phase5_badge_acquisition.rs # 徽章获取
│   ├── phase6_redemption.rs        # 兑换流程
│   ├── phase7_notification.rs      # 通知系统
│   ├── phase8_reverse_scenarios.rs # 逆向场景
│   ├── phase9_data_consistency.rs  # 数据一致性
│   └── phase10_reports.rs          # 报表统计
├── performance/
│   ├── mod.rs
│   ├── single_user_latency.rs      # 单用户延迟
│   ├── concurrent_acquisition.rs   # 并发获取
│   ├── cascade_performance.rs      # 级联性能
│   ├── competitive_redemption.rs   # 竞争兑换
│   └── mixed_workload.rs           # 混合负载
└── helpers/
    ├── mod.rs
    ├── api_client.rs               # API 客户端
    ├── db_verifier.rs              # 数据库验证
    ├── event_generator.rs          # 事件生成
    └── assertions.rs               # 断言工具
```

### 7.3 Mock Service 使用

```rust
// 示例: 使用 Mock Service 生成测试数据
use mock_services::{MockDataGenerator, scenarios};

// 1. 启动 Mock REST API
MockServer::start(8090).await;

// 2. 预填充测试用户
let users = MockDataGenerator::generate_users(100);

// 3. 使用预定义场景
let events = scenarios::first_purchase_flow("user-001");
kafka_producer.send_batch(events).await;

// 4. 验证徽章发放
let badges = api_client.get_user_badges("user-001").await;
assert!(badges.contains("first_purchase_badge"));
```

---

## 八、验收标准

### 8.1 功能验收
- [ ] 所有功能测试用例通过率 100%
- [ ] 逆向场景测试通过
- [ ] 数据一致性验证通过

### 8.2 性能验收
- [ ] 单用户延迟 P99 < 100ms
- [ ] 并发 1000 用户 TPS > 5000
- [ ] 竞争兑换无超卖
- [ ] 级联触发 5 级 < 1s

### 8.3 稳定性验收
- [ ] 持续运行 1 小时无内存泄漏
- [ ] 错误率 < 0.1%
- [ ] 无死锁

---

## 九、风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 外部服务不可用 | 测试阻塞 | 使用 Mock 服务替代 |
| 测试数据污染 | 结果不准确 | 每次测试前清理数据 |
| 性能测试资源不足 | 无法达到目标负载 | 分布式负载生成 |
| 前端自动化复杂 | 测试覆盖不全 | API 层测试为主 |

---

## 十、待确认事项

1. **性能目标**: 上述性能指标是否符合业务预期？
2. **测试环境**: 是否需要独立的测试环境？
3. **自动化程度**: 前端测试是否需要 Playwright/Cypress？
4. **Mock 服务范围**: 外部优惠券/积分系统是否需要 Mock？
5. **执行频率**: 是否需要 CI/CD 集成？
