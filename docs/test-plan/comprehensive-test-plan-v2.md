# Badge 系统全面测试方案 V2

## 一、测试架构概述

### 1.1 系统架构全景
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              前端 Admin UI                                   │
│  (画布规则编辑器 / 徽章管理 / 权益配置 / 报表)                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         badge-admin-service (REST :8080)                     │
│  (B端管理后台 API)                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
          ┌───────────────────────────┼───────────────────────────┐
          ▼                           ▼                           ▼
┌──────────────────┐    ┌──────────────────────┐    ┌──────────────────────┐
│  Kafka Topics    │    │ unified-rule-engine  │    │ badge-management-svc │
│ • engagement.events│   │     (gRPC :50051)    │    │    (gRPC :50052)     │
│ • transaction.events│  │   (规则评估/编译)     │    │  (徽章发放/兑换/级联) │
│ • notifications  │    └──────────────────────┘    └──────────────────────┘
│ • rule.reload    │              ▲                           ▲
│ • dlq            │              │                           │
└──────────────────┘              │                           │
          │                       │                           │
          ▼                       │                           │
┌──────────────────────────────────────────────────────────────────────────────┐
│                          事件消费层 (Kafka Consumers)                          │
├─────────────────────────────────┬────────────────────────────────────────────┤
│   event-engagement-service      │      event-transaction-service             │
│   (签到/浏览/分享/评价事件)       │      (购买/退款/取消事件)                   │
│   • 幂等检查 (Redis)             │      • 幂等检查 (Redis)                    │
│   • 规则校验 (时间窗口/配额)      │      • 规则校验 + 退款撤销逻辑              │
│   • 调用规则引擎评估              │      • 调用规则引擎评估                    │
│   • 调用徽章服务发放              │      • 调用徽章服务发放/撤销               │
│   • 投递通知消息                  │      • 投递通知消息                       │
└─────────────────────────────────┴────────────────────────────────────────────┘
                                      │
                                      ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                         notification-worker                                   │
│   (通知消费 → 多渠道并行发送: App Push / SMS / WeChat / Email)                 │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           外部系统集成                                         │
│   • 用户系统 (SWID)  • 订单系统  • 优惠券系统  • 积分系统  • 推送系统           │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 必须启动的服务清单

| 服务 | 端口 | 依赖 | 启动命令 |
|------|------|------|----------|
| PostgreSQL | 5432 | - | `make infra-up` |
| Redis | 6379 | - | `make infra-up` |
| Kafka | 9092 | - | `make infra-up` |
| unified-rule-engine | 50051 | PostgreSQL | `cargo run -p unified-rule-engine` |
| badge-management-service | 50052 | PostgreSQL, Redis, Kafka | `cargo run -p badge-management-service` |
| badge-admin-service | 8080 | PostgreSQL, Redis | `cargo run -p badge-admin-service` |
| event-engagement-service | - | Kafka, Redis, gRPC clients | `cargo run -p event-engagement-service` |
| event-transaction-service | - | Kafka, Redis, gRPC clients | `cargo run -p event-transaction-service` |
| notification-worker | - | Kafka | `cargo run -p notification-worker` |
| mock-services | 8090 | - | `cargo run -p mock-services` |

---

## 二、测试场景分类

### 2.1 场景矩阵

| 分类 | 子场景 | 涉及服务 | 优先级 |
|------|--------|----------|--------|
| **A. 基础配置** | 分类/系列/徽章/规则/权益 | admin-service | P0 |
| **B. 画布规则** | 可视化规则配置全流程 | admin-service, rule-engine | P0 |
| **C. 权益系统** | 权益同步/关联/发放 | admin-service, management-service | P0 |
| **D. 事件触发链路** | Kafka → 评估 → 发放 → 通知 | 全部 6 个服务 | P0 |
| **E. 级联触发** | 依赖图/自动点亮 | management-service | P0 |
| **F. 兑换流程** | 权益兑换/竞争兑换 | management-service | P0 |
| **G. 通知系统** | 多渠道通知 | notification-worker | P1 |
| **H. 逆向场景** | 退款/撤销/回滚 | event-transaction-service | P1 |
| **I. 数据一致性** | 前后端/数据库/缓存 | 全部 | P0 |
| **J. 外部系统对接** | Mock 外部服务 | mock-services | P1 |
| **K. 性能压测** | 并发/级联/竞争 | 全部 | P2 |

---

## 三、A. 基础配置模块测试

### A.1 徽章分类管理
| ID | 场景 | 前端操作 | API 调用 | DB 验证 |
|----|------|----------|----------|---------|
| A1-01 | 创建一级分类 | 填写名称、图标、描述 | POST /api/categories | badge_categories 新增 |
| A1-02 | 创建子分类 | 选择父分类 | POST /api/categories | parent_id 正确 |
| A1-03 | 分类排序 | 拖拽排序 | PATCH /api/categories/reorder | sort_order 更新 |
| A1-04 | 编辑分类 | 修改名称 | PUT /api/categories/:id | updated_at 更新 |
| A1-05 | 删除空分类 | 点击删除 | DELETE /api/categories/:id | 记录删除 |
| A1-06 | 删除非空分类 | 点击删除 | DELETE /api/categories/:id | 返回 400 错误 |

### A.2 徽章系列管理
| ID | 场景 | 验证点 |
|----|------|--------|
| A2-01 | 创建系列 | badge_series 新增 |
| A2-02 | 系列关联分类 | category_id 正确 |
| A2-03 | 系列进度配置 | progress_config JSON 正确 |
| A2-04 | 系列主题配置 | theme/color 配置正确 |

### A.3 徽章定义
| ID | 场景 | 配置项 | 验证点 |
|----|------|--------|--------|
| A3-01 | 创建普通徽章 | 基础信息 | badges 表新增 |
| A3-02 | 创建限量徽章 | max_supply=100 | 库存字段正确 |
| A3-03 | 创建限时徽章 | valid_from/valid_to | 时间范围正确 |
| A3-04 | 创建成就徽章 | badge_type=achievement | 类型正确 |
| A3-05 | 配置徽章素材 | icon_url/animated_url | assets JSON |
| A3-06 | 配置有效期 | validity_type + config | validity_config JSON |
| A3-07 | 徽章上线 | status: draft→active | 状态流转 |
| A3-08 | 徽章下线 | status: active→inactive | 无法继续发放 |

---

## 四、B. 画布规则配置测试

### B.1 规则与徽章关联
```
徽章获取规则配置流程：
1. 选择目标徽章
2. 配置触发事件类型 (purchase/checkin/share 等)
3. 在画布上配置条件和逻辑
4. 配置时间窗口 (start_time/end_time)
5. 配置配额限制 (max_count_per_user/global_quota)
6. 保存规则 → badge_rules 表
7. 触发规则热加载 → badge.rule.reload topic
```

### B.2 画布操作测试用例
| ID | 场景 | 操作 | 预期结果 |
|----|------|------|----------|
| B2-01 | 添加条件节点 | 从工具栏拖入 | 节点显示，可配置 |
| B2-02 | 配置条件 | 选择字段/操作符/值 | 条件数据保存 |
| B2-03 | 添加 AND 组 | 连接多个条件 | 逻辑组创建 |
| B2-04 | 添加 OR 组 | 创建或关系 | 逻辑组类型正确 |
| B2-05 | 嵌套逻辑 | (A AND B) OR C | 嵌套结构正确 |
| B2-06 | 删除节点 | 选中删除 | 节点和边移除 |
| B2-07 | 连接节点 | 拖拽连线 | 边关系创建 |
| B2-08 | 保存规则 | 点击保存 | JSON 结构存储 |
| B2-09 | 加载规则 | 打开已有规则 | 画布正确渲染 |
| B2-10 | 规则预览 | 查看规则描述 | 可读文本显示 |

### B.3 规则条件类型覆盖
| ID | 条件类型 | 示例 | 操作符 |
|----|----------|------|--------|
| B3-01 | 数值比较 | order.amount >= 1000 | eq, neq, gt, gte, lt, lte |
| B3-02 | 字符串匹配 | event.type == "PURCHASE" | eq, neq, contains, startsWith |
| B3-03 | 范围判断 | user.age BETWEEN [18, 60] | between |
| B3-04 | 列表包含 | event.type IN ["A", "B"] | in, notIn |
| B3-05 | 数组包含 | user.tags CONTAINS_ANY ["vip"] | containsAny, containsAll |
| B3-06 | 空值判断 | user.email IS_NOT_EMPTY | isEmpty, isNotEmpty |
| B3-07 | 时间比较 | event.time BEFORE "2024-12-31" | before, after |
| B3-08 | 正则匹配 | user.email REGEX ".*@disney.com" | regex |

### B.4 规则模板使用
| ID | 场景 | 预期结果 |
|----|------|----------|
| B4-01 | 选择模板 | 加载模板参数表单 |
| B4-02 | 填写参数 | 参数校验通过 |
| B4-03 | 生成规则 | 画布自动填充 |
| B4-04 | 修改生成规则 | 可以调整细节 |

### B.5 规则生效验证
| ID | 场景 | 验证点 |
|----|------|--------|
| B5-01 | 规则保存后立即生效 | rule.reload 消息发送 |
| B5-02 | 事件服务收到刷新 | 规则映射更新 |
| B5-03 | 新规则立即可用 | 后续事件使用新规则 |

---

## 五、C. 权益系统测试

### C.1 权益类型配置
| ID | 权益类型 | 配置项 | 外部系统 |
|----|----------|--------|----------|
| C1-01 | points (积分) | points_amount | 积分系统 |
| C1-02 | coupon (优惠券) | coupon_template_id, validity_days | 优惠券系统 |
| C1-03 | physical (实物) | sku_id, shipping_required | 物流系统 |
| C1-04 | digital_asset (数字资产) | asset_id, asset_type | NFT 系统 |
| C1-05 | membership (会员权益) | level_upgrade, days | 会员系统 |
| C1-06 | reservation (预约名额) | event_id, quota | 活动系统 |
| C1-07 | external_callback (外部回调) | callback_url, payload | 自定义 |

### C.2 权益与徽章关联
```
配置流程：
1. 创建权益定义 (benefits 表)
2. 选择徽章
3. 配置关联关系 (badge_benefits 表)
4. 配置触发条件：
   - 获取即发放
   - 兑换时发放
   - 满足额外条件发放
```

| ID | 场景 | 前端操作 | DB 验证 |
|----|------|----------|---------|
| C2-01 | 创建积分权益 | 配置 100 积分 | benefits 新增 |
| C2-02 | 关联到徽章 | 选择徽章绑定 | badge_benefits 关联 |
| C2-03 | 配置发放时机 | 选择"获取即发放" | trigger_type 字段 |
| C2-04 | 多权益关联 | 同时绑定积分+优惠券 | 多条关联记录 |

### C.3 外部权益同步
| ID | 场景 | 流程 | 验证点 |
|----|------|------|--------|
| C3-01 | 优惠券模板同步 | 调用外部 API 获取模板列表 | 缓存/显示正确 |
| C3-02 | 积分账户查询 | 查询用户积分余额 | 展示正确 |
| C3-03 | 会员等级同步 | 获取用户当前等级 | 用于规则判断 |
| C3-04 | 同步失败处理 | 外部服务超时 | 降级/重试策略 |

### C.4 权益发放流程
| ID | 场景 | 触发方式 | 验证点 |
|----|------|----------|--------|
| C4-01 | 获取徽章时自动发放积分 | 徽章发放成功 | benefit_grants 新增，外部调用 |
| C4-02 | 获取徽章时自动发放优惠券 | 徽章发放成功 | 外部优惠券系统调用 |
| C4-03 | 权益发放成功记录 | - | status=SUCCESS, external_ref |
| C4-04 | 权益发放失败重试 | 外部调用失败 | retry_count++, next_retry_at |
| C4-05 | 权益发放最终失败 | 重试耗尽 | status=FAILED, 告警 |

### C.5 用户权益查询
| ID | 场景 | API | 验证点 |
|----|------|-----|--------|
| C5-01 | 查询用户所有权益 | GET /api/users/:id/benefits | 返回完整列表 |
| C5-02 | 按类型筛选 | ?type=coupon | 筛选正确 |
| C5-03 | 按状态筛选 | ?status=SUCCESS | 筛选正确 |
| C5-04 | 外部渠道查询 | 第三方 API 调用 | 返回格式正确 |

---

## 六、D. 事件触发全链路测试

### D.1 完整链路验证
```
端到端流程（必须启动所有服务）：

1. Mock Service 生成事件数据
   ↓
2. 投递到 Kafka Topic (badge.engagement.events / badge.transaction.events)
   ↓
3. Event Service 消费事件
   ├── 3.1 幂等检查 (Redis SETNX)
   ├── 3.2 加载适用规则 (RuleMapping)
   └── 3.3 规则校验 (时间窗口/配额)
   ↓
4. gRPC 调用 Rule Engine 批量评估
   ↓
5. 规则匹配结果处理
   ↓
6. gRPC 调用 Badge Management 发放徽章
   ├── 6.1 库存检查
   ├── 6.2 用户限额检查
   ├── 6.3 创建 user_badges 记录
   ├── 6.4 写入 badge_ledger 账本
   └── 6.5 触发权益发放 (如有配置)
   ↓
7. 级联评估 (异步)
   ↓
8. 投递通知消息到 Kafka (badge.notifications)
   ↓
9. Notification Worker 消费
   └── 多渠道并行发送 (App/SMS/WeChat/Email)
   ↓
10. 验证完整数据链路
```

### D.2 行为事件测试 (event-engagement-service)
| ID | 事件类型 | 场景 | 规则示例 | 验证点 |
|----|----------|------|----------|--------|
| D2-01 | checkin | 首次签到 | count >= 1 | 新手签到徽章 |
| D2-02 | checkin | 连续7天签到 | consecutive_days >= 7 | 坚持签到徽章 |
| D2-03 | page_view | 浏览指定页面 | page_id == "xxx" | 探索者徽章 |
| D2-04 | share | 分享3次 | share_count >= 3 | 分享达人徽章 |
| D2-05 | review | 首次评价 | review_count >= 1 | 评论者徽章 |
| D2-06 | profile_update | 完善资料 | profile_complete == true | 完善资料徽章 |

### D.3 交易事件测试 (event-transaction-service)
| ID | 事件类型 | 场景 | 规则示例 | 验证点 |
|----|----------|------|----------|--------|
| D3-01 | purchase | 首次购买 | purchase_count == 1 | 首单徽章 |
| D3-02 | purchase | 累计消费1000 | total_amount >= 1000 | 消费徽章 |
| D3-03 | purchase | 单笔500+ | order.amount >= 500 | 大额订单徽章 |
| D3-04 | purchase | VIP用户购买 | user.is_vip AND amount >= 100 | VIP专属徽章 |
| D3-05 | refund | 退款后消费额变化 | - | 徽章保留/撤销逻辑 |
| D3-06 | order_cancel | 订单取消 | - | 相关事件不计入 |

### D.4 幂等性测试
| ID | 场景 | 操作 | 预期结果 |
|----|------|------|----------|
| D4-01 | 重复事件 | 同一 event_id 发送两次 | 第二次跳过处理 |
| D4-02 | 幂等键过期后 | 24小时后重发 | 重新处理 |
| D4-03 | Redis 不可用 | 幂等检查失败 | 降级处理/告警 |

### D.5 规则热加载测试
| ID | 场景 | 操作 | 预期结果 |
|----|------|------|----------|
| D5-01 | 新规则创建 | Admin 保存规则 | rule.reload 消息发送 |
| D5-02 | 事件服务刷新 | 收到刷新消息 | 规则映射更新 |
| D5-03 | 新规则立即生效 | 发送匹配事件 | 新规则被使用 |
| D5-04 | 定时刷新 | 等待刷新间隔 | 自动更新规则 |

### D.6 配额和限制测试
| ID | 场景 | 配置 | 验证点 |
|----|------|------|--------|
| D6-01 | 用户限额 | max_count_per_user=1 | 同用户第二次拒绝 |
| D6-02 | 全局配额 | global_quota=100 | 第101次拒绝 |
| D6-03 | 时间窗口 | start_time/end_time | 窗口外拒绝 |
| D6-04 | 库存限制 | max_supply=50 | 库存耗尽拒绝 |

---

## 七、E. 级联触发测试

### E.1 级联配置
```
配置流程：
1. 在 Admin UI 配置徽章依赖关系
2. 保存到 badge_dependency 表
3. 指定依赖类型：
   - prerequisite (前置条件)
   - mutually_exclusive (互斥)
   - cascade (级联触发)
```

### E.2 级联场景
| ID | 场景 | 依赖关系 | 预期结果 |
|----|------|----------|----------|
| E2-01 | 简单级联 | A → B | 获得A后自动检查B |
| E2-02 | 多级级联 | A → B → C | 链式触发 |
| E2-03 | 扇出级联 | A → [B, C, D] | 一对多触发 |
| E2-04 | 聚合级联 | [A, B] → C | 多对一触发 |
| E2-05 | 循环检测 | A → B → A | 检测并阻止 |
| E2-06 | 深度限制 | 超过5级 | 截断并告警 |

### E.3 前置条件
| ID | 场景 | 预期结果 |
|----|------|----------|
| E3-01 | 前置未满足 | 拒绝发放，返回原因 |
| E3-02 | 前置已满足 | 允许发放 |
| E3-03 | 多前置条件 | 全部满足才发放 |

### E.4 互斥关系
| ID | 场景 | 预期结果 |
|----|------|----------|
| E4-01 | 互斥徽章已持有 | 拒绝新徽章 |
| E4-02 | 互斥组冲突 | 选择优先级高的 |
| E4-03 | 解除互斥 | 撤销原徽章后可获新徽章 |

---

## 八、F. 兑换流程测试

### F.1 兑换配置
```
兑换规则配置：
1. 创建兑换规则 (redemption_rules 表)
2. 指定可兑换徽章和数量
3. 配置兑换获得的权益
4. 配置兑换限制 (次数/时间/库存)
```

### F.2 正常兑换
| ID | 场景 | 操作 | 验证点 |
|----|------|------|--------|
| F2-01 | 单徽章兑换积分 | 消耗1个徽章 | 积分到账 |
| F2-02 | 单徽章兑换优惠券 | 消耗1个徽章 | 优惠券发放 |
| F2-03 | 组合兑换 | 消耗A+B徽章 | 高级权益 |
| F2-04 | 部分兑换 | 仅兑换部分 | 剩余保留 |

### F.3 竞争兑换 (限量抢兑)
| ID | 场景 | 预期结果 |
|----|------|----------|
| F3-01 | 限量100抢兑 | 前100人成功 |
| F3-02 | 库存不足 | 返回库存不足错误 |
| F3-03 | 并发抢兑 | 分布式锁生效，无超卖 |
| F3-04 | 抢兑失败回滚 | 徽章数量恢复 |

### F.4 自动兑换
| ID | 场景 | 触发条件 | 验证点 |
|----|------|----------|--------|
| F4-01 | 获取即兑换 | 徽章发放成功 | 自动触发权益 |
| F4-02 | 集齐兑换 | 集齐系列全部徽章 | 自动合成奖励 |

---

## 九、G. 通知系统测试

### G.1 通知触发时机
| ID | 事件 | 通知类型 | 渠道 |
|----|------|----------|------|
| G1-01 | 获得新徽章 | BADGE_GRANTED | App Push |
| G1-02 | 徽章点亮 | BADGE_UNLOCKED | App Push |
| G1-03 | 兑换成功 | REDEMPTION_SUCCESS | App + SMS |
| G1-04 | 权益到账 | BENEFIT_GRANTED | App |
| G1-05 | 徽章即将过期 | BADGE_EXPIRING | App + SMS |
| G1-06 | 徽章已撤销 | BADGE_REVOKED | App |

### G.2 多渠道发送
| ID | 场景 | 预期结果 |
|----|------|----------|
| G2-01 | 单渠道发送 | 指定渠道收到 |
| G2-02 | 多渠道并行 | 全部渠道收到 |
| G2-03 | 部分渠道失败 | 其他渠道不受影响 |
| G2-04 | 全部渠道失败 | 投递到死信队列 |

### G.3 通知内容验证
| ID | 场景 | 验证点 |
|----|------|--------|
| G3-01 | 模板渲染 | 变量正确替换 |
| G3-02 | 徽章名称 | 显示正确 |
| G3-03 | 权益详情 | 积分/优惠券金额正确 |
| G3-04 | 过期时间 | 剩余天数正确 |

---

## 十、H. 逆向场景测试

### H.1 退款撤销
| ID | 场景 | 操作 | 预期结果 |
|----|------|------|----------|
| H1-01 | 全额退款 | 原订单触发的徽章 | 根据配置撤销 |
| H1-02 | 部分退款 | 金额下降但仍达标 | 徽章保留 |
| H1-03 | 部分退款 | 金额下降不再达标 | 可配置撤销 |
| H1-04 | 退款后重新购买 | 消费额恢复 | 可重新获得 |

### H.2 徽章撤销
| ID | 场景 | 操作 | 预期结果 |
|----|------|------|----------|
| H2-01 | 管理员撤销 | Admin 操作 | 状态变 revoked |
| H2-02 | 系统自动撤销 | 违规检测 | 状态变 revoked |
| H2-03 | 撤销通知 | - | 发送撤销通知 |
| H2-04 | 撤销后权益 | - | 已发放权益是否回收 |

### H.3 权益撤销
| ID | 场景 | 预期结果 |
|----|------|----------|
| H3-01 | 撤销未使用优惠券 | 优惠券作废 |
| H3-02 | 撤销已使用优惠券 | 记录但不强制回收 |
| H3-03 | 撤销积分 | 积分扣减 |

### H.4 异常场景
| ID | 场景 | 处理方式 | 验证点 |
|----|------|----------|--------|
| H4-01 | 规则引擎超时 | 重试/降级 | 告警触发 |
| H4-02 | 数据库连接失败 | 重试机制 | 服务不崩溃 |
| H4-03 | Kafka 消息积压 | 消费限流 | 监控告警 |
| H4-04 | 外部服务不可用 | 熔断降级 | 记录失败待重试 |
| H4-05 | 死信队列 | 人工介入 | 消息不丢失 |

---

## 十一、I. 数据一致性验证

### I.1 前后端一致性
| 检查点 | 前端数据 | 后端验证 | DB 验证 |
|--------|----------|----------|---------|
| 徽章创建 | 表单提交 | API 响应 | badges 表 |
| 规则保存 | 画布 JSON | 规则存储 | badge_rules 表 |
| 权益配置 | 配置表单 | 解析正确 | benefits 表 |
| 用户徽章 | 列表展示 | API 返回 | user_badges 表 |

### I.2 事务一致性
| 检查点 | 场景 | 验证方法 |
|--------|------|----------|
| 徽章发放 | 发放+账本 | 两表数据一致 |
| 兑换事务 | 扣减+权益 | 事务回滚测试 |
| 级联发放 | 多徽章连锁 | 全成功或全回滚 |
| 库存扣减 | 并发扣减 | 无超卖 |

### I.3 缓存一致性
| 检查点 | 场景 | 验证方法 |
|--------|------|----------|
| 规则缓存 | 规则更新 | 缓存失效/刷新 |
| 用户徽章缓存 | 发放/撤销 | 缓存同步更新 |
| 幂等键 | 过期策略 | 24小时后可重复处理 |

---

## 十二、J. 外部系统对接测试 (Mock)

### J.1 Mock 服务配置
```bash
# 启动 Mock 服务
cargo run -p mock-services

# 提供的 Mock API:
# - GET  /api/users/:id          # 用户信息
# - GET  /api/orders/:id         # 订单信息
# - POST /api/coupons/issue      # 发放优惠券
# - POST /api/points/add         # 添加积分
# - POST /api/push/send          # 发送推送
```

### J.2 Mock 场景
| ID | 外部系统 | Mock 行为 | 用途 |
|----|----------|-----------|------|
| J2-01 | 用户系统 | 返回用户档案 | 规则判断 |
| J2-02 | 订单系统 | 返回订单详情 | 交易事件验证 |
| J2-03 | 优惠券系统-成功 | 返回券号 | 正常流程 |
| J2-04 | 优惠券系统-失败 | 返回错误 | 重试流程 |
| J2-05 | 积分系统-成功 | 返回余额 | 正常流程 |
| J2-06 | 积分系统-延迟 | 5秒响应 | 超时处理 |
| J2-07 | 推送系统 | 记录通知 | 通知验证 |

### J.3 外部数据同步
| ID | 场景 | Mock 数据 | 验证点 |
|----|------|-----------|--------|
| J3-01 | 优惠券模板同步 | 10个模板 | 正确展示 |
| J3-02 | 会员等级查询 | VIP/SVIP | 规则条件判断 |
| J3-03 | 用户历史订单 | 累计金额 | 消费徽章判断 |

---

## 十三、K. 性能测试

### K.1 基准测试 (Criterion)
```bash
# 规则引擎性能
cargo bench --bench rule_engine_bench

# 条件评估性能
cargo bench -p unified-rule-engine --bench evaluator_bench
```

### K.2 并发场景
| 场景 | 并发数 | 目标 |
|------|--------|------|
| 单用户徽章获取 | 1 | P99 < 100ms |
| 并发事件处理 | 100 | TPS > 1000 |
| 并发事件处理 | 1000 | TPS > 5000 |
| 级联触发 (5级) | 100 | 完成 < 1s |
| 竞争兑换 | 1000 抢 100 | 无超卖 |

### K.3 混合负载
```
读写比例: 7:3
操作分布:
  - 40% 事件触发
  - 30% 查询徽章
  - 20% 兑换操作
  - 10% 管理操作
```

### K.4 稳定性测试
| 指标 | 目标 |
|------|------|
| 持续运行 | 1小时无内存泄漏 |
| 错误率 | < 0.1% |
| 无死锁 | 通过 |

---

## 十四、测试执行计划

### 14.1 环境准备检查清单
- [ ] PostgreSQL 启动并完成 migration
- [ ] Redis 启动
- [ ] Kafka 启动并创建 topics
- [ ] unified-rule-engine 启动并健康检查通过
- [ ] badge-management-service 启动并健康检查通过
- [ ] badge-admin-service 启动并健康检查通过
- [ ] event-engagement-service 启动并连接 Kafka
- [ ] event-transaction-service 启动并连接 Kafka
- [ ] notification-worker 启动并连接 Kafka
- [ ] mock-services 启动
- [ ] 前端 Admin UI 启动

### 14.2 执行顺序
```
Phase 1: 环境验证 (30min)
  └── 验证所有服务启动和连通性

Phase 2: 基础配置 (2h)
  ├── A.1-A.3 分类/系列/徽章
  └── 数据准备

Phase 3: 规则配置 (3h)
  ├── B.2-B.5 画布操作全流程
  └── 规则热加载验证

Phase 4: 权益配置 (2h)
  ├── C.1-C.2 权益定义和关联
  ├── C.3 外部同步 Mock
  └── C.4-C.5 发放和查询

Phase 5: 全链路测试 (4h)
  ├── D.2-D.3 事件触发全场景
  ├── D.4-D.6 幂等/热加载/配额
  └── 端到端数据验证

Phase 6: 级联和兑换 (2h)
  ├── E.2-E.4 级联场景
  └── F.2-F.4 兑换场景

Phase 7: 通知和逆向 (2h)
  ├── G.1-G.3 通知验证
  └── H.1-H.4 逆向场景

Phase 8: 一致性验证 (1h)
  └── I.1-I.3 数据一致性

Phase 9: 性能测试 (2h)
  └── K.1-K.4 性能场景

总计: ~18小时
```

### 14.3 测试报告模板
```markdown
# 测试报告 - [日期]

## 执行概要
- 总用例数: xxx
- 通过: xxx (xx%)
- 失败: xxx (xx%)
- 跳过: xxx

## 失败用例
| ID | 场景 | 失败原因 | 严重程度 |
|----|------|----------|----------|

## 性能结果
| 场景 | 目标 | 实际 | 是否达标 |
|------|------|------|----------|

## 遗留问题
1. ...

## 建议
1. ...
```

---

## 十五、待确认事项

1. **Mock 服务范围**: 外部系统 Mock 是否需要扩展？
2. **性能目标**: 上述性能指标是否符合业务预期？
3. **自动化程度**: 是否需要 Playwright 前端自动化？
4. **CI/CD 集成**: 是否需要集成到 CI pipeline？
5. **测试数据**: 是否需要准备特定的测试数据集？
